
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise do Exame - Sistema OCT Premium</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-premium">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <i class="fas fa-eye me-2"></i>Sistema OCT Premium
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'home' %}">
                    <i class="fas fa-home me-1"></i>Início
                </a>
                <a class="nav-link" href="{% url 'paciente_list' %}">
                    <i class="fas fa-users me-1"></i>Pacientes
                </a>
                <a class="nav-link" href="{% url 'logout' %}">
                    <i class="fas fa-sign-out-alt me-1"></i>Sair
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid">
        <div class="main-container fade-in-up">
            <div class="text-center mb-4">
                <h2 class="text-primary">
                    <i class="fas fa-microscope me-2"></i>Análise do Exame OCT
                </h2>
                <p class="text-muted">Diagnóstico inteligente com tecnologia de IA</p>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card-premium">
                        <div class="card-header">
                            <i class="fas fa-user-injured me-2"></i>Dados do Paciente
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <strong class="text-primary">
                                        <i class="fas fa-user me-1"></i>Paciente:
                                    </strong>
                                    <br>{{ exame.paciente.nome }}
                                </div>
                                <div class="col-6 mb-3">
                                    <strong class="text-primary">
                                        <i class="fas fa-birthday-cake me-1"></i>Nascimento:
                                    </strong>
                                    <br>{{ exame.paciente.data_nascimento|date:"d/m/Y" }}
                                </div>
                                <div class="col-6 mb-3">
                                    <strong class="text-primary">
                                        <i class="fas fa-id-card me-1"></i>Prontuário:
                                    </strong>
                                    <br>{{ exame.paciente.prontuario|default:"N/A" }}
                                </div>
                                <div class="col-6 mb-3">
                                    <strong class="text-primary">
                                        <i class="fas fa-calendar me-1"></i>Data do Exame:
                                    </strong>
                                    <br>{{ exame.data_exame|date:"d/m/Y H:i" }}
                                </div>
                                <div class="col-6 mb-3">
                                    <strong class="text-primary">
                                        <i class="fas fa-user-md me-1"></i>Realizado por:
                                    </strong>
                                    <br>{{ exame.usuario.get_full_name|default:exame.usuario.username }}
                                </div>
                                <div class="col-6 mb-3">
                                    <strong class="text-primary">
                                        <i class="fas fa-info-circle me-1"></i>Status:
                                    </strong>
                                    <br>
                                    <span class="status-badge 
                                        {% if exame.status == 'concluido' %}bg-success
                                        {% elif exame.status == 'analisando' %}bg-warning
                                        {% elif exame.status == 'erro' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        <i class="fas fa-circle me-1"></i>{{ exame.get_status_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="card-premium">
                        <div class="card-header">
                            <i class="fas fa-image me-2"></i>Imagem OCT
                        </div>
                        <div class="card-body text-center">
                            {% if exame.imagem %}
                                <img src="{{ exame.imagem.url }}" alt="Imagem OCT" class="image-premium" style="max-height: 350px; width: 100%; object-fit: contain;">
                            {% else %}
                                <div class="py-5">
                                    <i class="fas fa-image fa-4x text-muted mb-3"></i>
                                    <p class="text-muted">Nenhuma imagem disponível</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card-premium">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-brain me-2"></i>Diagnóstico por Inteligência Artificial
                            </span>
                            {% if not exame.diagnostico_ia %}
                                <button class="btn btn-premium btn-primary-premium" onclick="analisarComIA()">
                                    <i class="fas fa-robot me-2"></i>Analisar com IA
                                </button>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if exame.diagnostico_ia %}
                                <div class="diagnostico-premium">
                                    <div id="diagnostico-formatado">
                                        {{ exame.diagnostico_ia|linebreaks }}
                                    </div>
                                </div>
                                {% if exame.data_diagnostico %}
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Analisado em: {{ exame.data_diagnostico|date:"d/m/Y H:i" }}
                                        </small>
                                    </div>
                                {% endif %}
                                
                                <div class="mt-4 text-center">
                                    {% if not exame.laudo_pdf %}
                                        <button class="btn btn-premium btn-success-premium" onclick="gerarLaudo()">
                                            <i class="fas fa-file-pdf me-2"></i>Gerar Laudo PDF
                                        </button>
                                    {% else %}
                                        <a href="{{ exame.laudo_pdf.url }}" class="btn btn-premium btn-success-premium" target="_blank">
                                            <i class="fas fa-download me-2"></i>Download Laudo PDF
                                        </a>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-robot fa-4x text-muted mb-4"></i>
                                    <h5 class="text-muted">Aguardando Análise por IA</h5>
                                    <p class="text-muted">Clique no botão "Analisar com IA" para processar a imagem</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'home' %}" class="btn btn-premium btn-primary-premium me-2">
                    <i class="fas fa-home me-2"></i>Voltar ao Início
                </a>
                <a href="{% url 'exame_create' %}" class="btn btn-premium btn-warning-premium">
                    <i class="fas fa-plus-circle me-2"></i>Novo Exame
                </a>
            </div>
        </div>
    </div>

    <script>
        // Formatar diagnóstico ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            formatarDiagnostico();
        });

        function formatarDiagnostico() {
            const diagnosticoElement = document.getElementById('diagnostico-formatado');
            if (diagnosticoElement) {
                let content = diagnosticoElement.innerHTML;
                
                // Marcar seções especiais
                content = content.replace(/### DIAGNÓSTICO DIFERENCIAL([\s\S]*?)(?=###|$)/gi, 
                    '<div class="diagnostico-principal"><h3>DIAGNÓSTICO DIFERENCIAL</h3>$1</div>');
                
                content = content.replace(/### RECOMENDAÇÕES CLÍNICAS([\s\S]*?)(?=###|$)/gi, 
                    '<div class="recomendacoes"><h3>RECOMENDAÇÕES CLÍNICAS</h3>$1</div>');
                
                // Destacar termos médicos importantes
                const termosImportantes = [
                    'DMRI', 'OCT', 'EPR', 'CNV', 'EMD', 'VEGF', 'AFG', 'DRIL',
                    'μm', 'microns', 'foveal', 'macular', 'retiniano', 'sub-retiniano',
                    'intraretiniano', 'neovascular', 'drusenóide', 'cistoide'
                ];
                
                termosImportantes.forEach(termo => {
                    const regex = new RegExp(`\\b(${termo})\\b`, 'gi');
                    content = content.replace(regex, '<span class="termo-medico">$1</span>');
                });
                
                // Destacar valores numéricos e medidas
                content = content.replace(/(\d+)\s*(μm|microns|mm|%)/gi, 
                    '<span class="valor-medico">$1 $2</span>');
                
                // Classificações de severidade
                content = content.replace(/\b(severo|grave|avançado)\b/gi, 
                    '<span class="classificacao severo">$1</span>');
                content = content.replace(/\b(moderado|médio)\b/gi, 
                    '<span class="classificacao moderado">$1</span>');
                content = content.replace(/\b(leve|inicial|mínimo)\b/gi, 
                    '<span class="classificacao leve">$1</span>');
                
                diagnosticoElement.innerHTML = content;
            }
        }

        async function analisarComIA() {
            const button = document.querySelector('button[onclick="analisarComIA()"]');
            const originalText = button.innerHTML;
            
            try {
                // Verificar se a chave Gemini está configurada
                const keyCheck = await fetch('/api/check-gemini-key/');
                const keyData = await keyCheck.json();
                
                if (!keyData.key_configured) {
                    alert('❌ Chave API do Gemini não configurada.\n\nPor favor, configure a chave no painel administrativo.');
                    return;
                }
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analisando...';
                button.disabled = true;
                
                // Fazer requisição para análise
                const response = await fetch(`/exames/{{ exame.id }}/analise-ia/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Atualizar página com o diagnóstico
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    alert('❌ Erro na análise:\n' + (data.error || 'Erro desconhecido'));
                }
                
            } catch (error) {
                console.error('Erro:', error);
                alert('❌ Erro ao processar análise:\n' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function gerarLaudo() {
            try {
                const response = await fetch(`/exames/{{ exame.id }}/gerar-laudo-pdf/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                if (response.ok) {
                    // Criar link para download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `laudo_{{ exame.paciente.nome|slugify }}_{{ exame.data_exame|date:"Y-m-d" }}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    // Recarregar página para mostrar o link do PDF salvo
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const data = await response.json();
                    alert('❌ Erro ao gerar PDF:\n' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('❌ Erro ao gerar PDF:\n' + error.message);
            }
        }
    </script>
    
    <!-- Token CSRF para JavaScript -->
    {% csrf_token %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
